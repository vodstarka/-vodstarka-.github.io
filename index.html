<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ«ãƒãƒ¡ãƒ‡ã‚£ã‚¢å˜èªå¸³ã‚¢ãƒ—ãƒª</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .card {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
            position: relative;
        }
        .card:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .card-content {
            flex-grow: 1;
        }
        .media-container {
            margin: 10px 0;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .media-preview {
            max-width: 100%;
            max-height: 200px;
            margin-bottom: 10px;
        }
        audio, video {
            width: 100%;
            max-width: 400px;
        }
        .file-icon {
            font-size: 48px;
            color: #555;
        }
        .card-description {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 10px;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            min-width: 120px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.delete {
            background-color: #f44336;
        }
        button.delete:hover {
            background-color: #d32f2f;
        }
        button.edit {
            background-color: #2196F3;
        }
        button.edit:hover {
            background-color: #0b7dda;
        }
        button.secondary {
            background-color: #9e9e9e;
        }
        button.secondary:hover {
            background-color: #757575;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .card-set-list {
            margin-top: 20px;
        }
        .card-set-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-set-item:hover {
            background-color: #f0f0f0;
        }
        .card-set-item.active {
            background-color: #e0e0e0;
            font-weight: bold;
        }
        .card-set-actions {
            display: flex;
            gap: 5px;
        }
        .group-selector {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 4px;
        }
        .group-selector select {
            width: 200px;
            padding: 5px;
            margin-right: 10px;
        }
        .url-button {
            display: inline-block;
            padding: 5px 10px;
            background-color: #2196F3;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin-top: 10px;
        }
        .url-button.disabled {
            background-color: #ccc;
            cursor: not-allowed;
            pointer-events: none;
        }
        .navigation {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .progress {
            text-align: center;
            margin: 10px 0;
            color: #666;
        }
        .view-toggle {
            display: flex;
            justify-content: center;
            margin: 15px 0;
        }
        .view-toggle button {
            border-radius: 0;
            margin: 0;
        }
        .view-toggle button:first-child {
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
        }
        .view-toggle button:last-child {
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
        }
        .view-toggle button.active {
            background-color: #2E7D32;
        }
        .card-list {
            margin-top: 20px;
        }
        .card-list-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            background-color: white;
            cursor: pointer;
        }
        .card-list-item:hover {
            background-color: #f9f9f9;
        }
        .card-list-item.active {
            border-color: #4CAF50;
            background-color: #f0f8f0;
        }
        .card-list-item h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .card-list-item p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }
        .card-list-media {
            max-width: 100px;
            max-height: 60px;
            margin-right: 10px;
            float: left;
        }
        .clearfix::after {
            content: "";
            display: table;
            clear: both;
        }
        .hidden {
            display: none;
        }
        .card-side-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        .media-type-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        .tab-container {
            display: flex;
            margin-bottom: 15px;
        }
        .tab {
            padding: 10px 15px;
            background-color: #e0e0e0;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .group-header {
            background-color: #f8f8f8;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }
        .group-header:hover {
            background-color: #f0f0f0;
        }
        .group-content {
            margin-left: 20px;
            display: none;
        }
        .group-content.expanded {
            display: block;
        }
        .group-toggle {
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            transition: transform 0.3s;
        }
        .group-toggle.expanded {
            transform: rotate(45deg);
        }
        .group-header .group-count {
            color: #666;
            font-size: 0.9em;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ãƒãƒ«ãƒãƒ¡ãƒ‡ã‚£ã‚¢å˜èªå¸³ã‚¢ãƒ—ãƒª</h1>
        
        <div class="controls" style="margin-bottom: 20px;">
            <button id="exportAll" class="secondary">å…¨ã¦ã®å˜èªå¸³ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <button id="importAll" class="secondary">å…¨ã¦ã®å˜èªå¸³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
            <input type="file" id="importAllFile" accept=".json" style="display: none;">
        </div>
        
        <div class="form-group">
            <label for="cardSetName">å˜èªå¸³ã‚»ãƒƒãƒˆå</label>
            <input type="text" id="cardSetName" placeholder="æ–°ã—ã„å˜èªå¸³ã‚»ãƒƒãƒˆåã‚’å…¥åŠ›">
            <select id="cardSetGroup">
                <option value="">ã‚°ãƒ«ãƒ¼ãƒ—ãªã—</option>
                <option value="new">æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ</option>
            </select>
            <input type="text" id="newGroupName" placeholder="æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—å" style="display: none;">
            <button id="createCardSet">æ–°ã—ã„å˜èªå¸³ã‚»ãƒƒãƒˆã‚’ä½œæˆ</button>
        </div>
        
        <div class="card-set-list" id="cardSetList">
            <h3>å˜èªå¸³ã‚»ãƒƒãƒˆä¸€è¦§</h3>
            <!-- å˜èªå¸³ã‚»ãƒƒãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
        
        <div id="cardSetView" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 id="currentCardSetName">å˜èªå¸³ã‚»ãƒƒãƒˆå</h2>
                <div>
                    <button id="editCardSet" class="edit">ã‚»ãƒƒãƒˆã‚’ç·¨é›†</button>
                    <button id="exportCardSet" class="secondary">ã‚»ãƒƒãƒˆã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    <button id="importCardSet" class="secondary">ã‚»ãƒƒãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                    <input type="file" id="importCardSetFile" accept=".json" style="display: none;">
                </div>
            </div>
            
            <div class="group-selector">
                <label for="groupFilter">ã‚°ãƒ«ãƒ¼ãƒ—ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼š</label>
                <select id="groupFilter">
                    <option value="">å…¨ã¦ã®ã‚°ãƒ«ãƒ¼ãƒ—</option>
                </select>
            </div>
            
            <div class="view-toggle">
                <button id="viewCard" class="active">ã‚«ãƒ¼ãƒ‰è¡¨ç¤º</button>
                <button id="viewList">ãƒªã‚¹ãƒˆè¡¨ç¤º</button>
            </div>
            
            <!-- ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºãƒ“ãƒ¥ãƒ¼ -->
            <div id="cardView">
                <div class="card" id="flashcard" onclick="flipCard()">
                    <div class="card-side-indicator" id="sideIndicator">è¡¨</div>
                    <div class="media-type-indicator" id="mediaTypeIndicator"></div>
                    <div class="card-content" id="cardContent">
                        <div id="cardFront">ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åè»¢</div>
                        <div id="cardBack" style="display: none;"></div>
                    </div>
                    <div class="media-container" id="mediaContainer"></div>
                    <div class="card-description" id="cardDescription" style="display: none;"></div>
                    <a id="urlButton" class="url-button disabled" href="#" target="_blank" rel="noopener noreferrer">URL</a>
                    <button id="toggleDescription" class="secondary" style="margin-top: 10px; display: none;">æ¦‚è¦ã‚’è¡¨ç¤º</button>
                </div>
                
                <div class="progress">
                    <span id="currentCardIndex">0</span> / <span id="totalCards">0</span>
                </div>
                
                <div class="navigation">
                    <button id="prevCard">å‰ã¸</button>
                    <button id="nextCard">æ¬¡ã¸</button>
                </div>
            </div>
            
            <!-- ãƒªã‚¹ãƒˆè¡¨ç¤ºãƒ“ãƒ¥ãƒ¼ -->
            <div id="listView" class="hidden">
                <div class="card-list" id="cardListContainer">
                    <!-- ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
            
            <div class="controls">
                <button id="addCard">ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ </button>
                <button class="edit" id="editCard">ã‚«ãƒ¼ãƒ‰ã‚’ç·¨é›†</button>
                <button class="delete" id="deleteCard">ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤</button>
            </div>
        </div>
        
        <!-- ã‚«ãƒ¼ãƒ‰è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="cardModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background-color: white; padding: 20px; border-radius: 8px; width: 80%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
                <h2 id="modalTitle">ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ </h2>
                <div class="form-group">
                    <label for="frontText">è¡¨ï¼ˆå˜èª/è³ªå•ï¼‰</label>
                    <textarea id="frontText" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="backText">è£ï¼ˆæ„å‘³/ç­”ãˆï¼‰</label>
                    <textarea id="backText" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="cardUrl">URL</label>
                    <input type="url" id="cardUrl" placeholder="é–¢é€£ã™ã‚‹URLã‚’å…¥åŠ›">
                </div>
                <div class="form-group">
                    <label for="cardDescriptionText">æ¦‚è¦ï¼ˆãƒ¡ãƒ¢ï¼‰</label>
                    <textarea id="cardDescriptionText" rows="2" placeholder="è¿½åŠ æƒ…å ±ã‚„ä¾‹æ–‡ãªã©ã‚’å…¥åŠ›"></textarea>
                </div>
                
                <div class="tab-container">
                    <div class="tab active" data-tab="media">ãƒ¡ãƒ‡ã‚£ã‚¢</div>
                    <div class="tab" data-tab="text">ãƒ†ã‚­ã‚¹ãƒˆ</div>
                </div>
                
                <div class="tab-content active" id="mediaTab">
                    <div class="form-group">
                        <label for="mediaUpload">ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
                        <input type="file" id="mediaUpload" accept="image/*,audio/*,video/*">
                        <div style="margin-top: 10px;">
                            <div id="mediaPreviewContainer"></div>
                            <button id="removeMedia" class="secondary" style="display: none; margin-top: 5px;">ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’å‰Šé™¤</button>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="textTab">
                    <div class="form-group">
                        <label for="additionalText">è¿½åŠ ãƒ†ã‚­ã‚¹ãƒˆ</label>
                        <textarea id="additionalText" rows="3" placeholder="è£œè¶³ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›"></textarea>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button id="cancelModal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button id="saveCard">ä¿å­˜</button>
                </div>
            </div>
        </div>
        
        <!-- ã‚«ãƒ¼ãƒ‰ã‚»ãƒƒãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="cardSetModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background-color: white; padding: 20px; border-radius: 8px; width: 80%; max-width: 500px;">
                <h2>å˜èªå¸³ã‚»ãƒƒãƒˆã‚’ç·¨é›†</h2>
                <div class="form-group">
                    <label for="editCardSetName">ã‚»ãƒƒãƒˆå</label>
                    <input type="text" id="editCardSetName">
                </div>
                <div class="form-group">
                    <label for="editCardSetDescription">ã‚»ãƒƒãƒˆèª¬æ˜</label>
                    <textarea id="editCardSetDescription" rows="2"></textarea>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                    <button id="deleteCardSet" class="delete">ã‚»ãƒƒãƒˆã‚’å‰Šé™¤</button>
                    <div>
                        <button id="cancelCardSetModal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button id="saveCardSet">ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å˜èªå¸³ãƒ‡ãƒ¼ã‚¿
        let cardSets = JSON.parse(localStorage.getItem('cardSets')) || [];
        let currentCardSetIndex = -1;
        let currentCardIndex = 0;
        let isFlipped = false;
        let isEditing = false;
        let editCardIndex = -1;
        let currentView = 'card'; // 'card' or 'list'
        let tempMediaData = null;
        let tempMediaType = null;
        let tempAdditionalText = null;
        let currentGroupFilter = ''; // ç¾åœ¨ã®ã‚°ãƒ«ãƒ¼ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼

        // DOMè¦ç´ 
        const cardSetNameInput = document.getElementById('cardSetName');
        const createCardSetBtn = document.getElementById('createCardSet');
        const cardSetList = document.getElementById('cardSetList');
        const cardSetView = document.getElementById('cardSetView');
        const currentCardSetName = document.getElementById('currentCardSetName');
        const flashcard = document.getElementById('flashcard');
        const cardFront = document.getElementById('cardFront');
        const cardBack = document.getElementById('cardBack');
        const cardDescription = document.getElementById('cardDescription');
        const mediaContainer = document.getElementById('mediaContainer');
        const prevCardBtn = document.getElementById('prevCard');
        const nextCardBtn = document.getElementById('nextCard');
        const addCardBtn = document.getElementById('addCard');
        const editCardBtn = document.getElementById('editCard');
        const deleteCardBtn = document.getElementById('deleteCard');
        const currentCardIndexSpan = document.getElementById('currentCardIndex');
        const totalCardsSpan = document.getElementById('totalCards');
        const cardModal = document.getElementById('cardModal');
        const modalTitle = document.getElementById('modalTitle');
        const frontText = document.getElementById('frontText');
        const backText = document.getElementById('backText');
        const cardDescriptionText = document.getElementById('cardDescriptionText');
        const mediaUpload = document.getElementById('mediaUpload');
        const mediaPreviewContainer = document.getElementById('mediaPreviewContainer');
        const removeMediaBtn = document.getElementById('removeMedia');
        const cancelModalBtn = document.getElementById('cancelModal');
        const saveCardBtn = document.getElementById('saveCard');
        const viewCardBtn = document.getElementById('viewCard');
        const viewListBtn = document.getElementById('viewList');
        const cardView = document.getElementById('cardView');
        const listView = document.getElementById('listView');
        const cardListContainer = document.getElementById('cardListContainer');
        const sideIndicator = document.getElementById('sideIndicator');
        const mediaTypeIndicator = document.getElementById('mediaTypeIndicator');
        const exportCardSetBtn = document.getElementById('exportCardSet');
        const importCardSetBtn = document.getElementById('importCardSet');
        const importCardSetFile = document.getElementById('importCardSetFile');
        const editCardSetBtn = document.getElementById('editCardSet');
        const cardSetModal = document.getElementById('cardSetModal');
        const editCardSetName = document.getElementById('editCardSetName');
        const editCardSetDescription = document.getElementById('editCardSetDescription');
        const deleteCardSetBtn = document.getElementById('deleteCardSet');
        const cancelCardSetModalBtn = document.getElementById('cancelCardSetModal');
        const saveCardSetBtn = document.getElementById('saveCardSet');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const additionalText = document.getElementById('additionalText');
        const toggleDescriptionBtn = document.getElementById('toggleDescription');
        const exportAllBtn = document.getElementById('exportAll');
        const importAllBtn = document.getElementById('importAll');
        const importAllFile = document.getElementById('importAllFile');
        const cardUrl = document.getElementById('cardUrl');
        const cardSetGroup = document.getElementById('cardSetGroup');
        const newGroupName = document.getElementById('newGroupName');
        const groupFilter = document.getElementById('groupFilter');
        const urlButton = document.getElementById('urlButton');

        // åˆæœŸåŒ–
        function init() {
            renderCardSetList();
            loadFromLocalStorage();
            updateGroupSelectors();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            createCardSetBtn.addEventListener('click', createCardSet);
            prevCardBtn.addEventListener('click', showPrevCard);
            nextCardBtn.addEventListener('click', showNextCard);
            addCardBtn.addEventListener('click', showAddCardModal);
            editCardBtn.addEventListener('click', showEditCardModal);
            deleteCardBtn.addEventListener('click', deleteCurrentCard);
            cancelModalBtn.addEventListener('click', hideModal);
            saveCardBtn.addEventListener('click', saveCard);
            viewCardBtn.addEventListener('click', () => switchView('card'));
            viewListBtn.addEventListener('click', () => switchView('list'));
            mediaUpload.addEventListener('change', handleMediaUpload);
            removeMediaBtn.addEventListener('click', removeMedia);
            exportCardSetBtn.addEventListener('click', exportCardSet);
            importCardSetBtn.addEventListener('click', () => importCardSetFile.click());
            importCardSetFile.addEventListener('change', handleImportCardSet);
            editCardSetBtn.addEventListener('click', showEditCardSetModal);
            deleteCardSetBtn.addEventListener('click', deleteCurrentCardSet);
            cancelCardSetModalBtn.addEventListener('click', hideCardSetModal);
            saveCardSetBtn.addEventListener('click', saveCardSet);
            toggleDescriptionBtn.addEventListener('click', toggleDescription);
            exportAllBtn.addEventListener('click', exportAllCardSets);
            importAllBtn.addEventListener('click', () => importAllFile.click());
            importAllFile.addEventListener('change', handleImportAllCardSets);
            cardSetGroup.addEventListener('change', handleGroupChange);
            groupFilter.addEventListener('change', handleGroupFilterChange);
            
            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
        }

        // ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabId) {
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            tabContents.forEach(content => {
                if (content.id === `${tabId}Tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        // å˜èªå¸³ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        function renderCardSetList() {
            cardSetList.innerHTML = '<h3>å˜èªå¸³ã‚»ãƒƒãƒˆä¸€è¦§</h3>';
            
            if (cardSets.length === 0) {
                cardSetList.innerHTML += '<p>å˜èªå¸³ã‚»ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            // ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«å˜èªå¸³ã‚’åˆ†é¡
            const groupedSets = {};
            cardSets.forEach(set => {
                const group = set.group || 'ã‚°ãƒ«ãƒ¼ãƒ—ãªã—';
                if (!groupedSets[group]) {
                    groupedSets[group] = [];
                }
                groupedSets[group].push(set);
            });

            // ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«è¡¨ç¤º
            Object.entries(groupedSets).forEach(([group, sets]) => {
                const groupHeader = document.createElement('div');
                groupHeader.className = 'group-header';
                groupHeader.innerHTML = `
                    <div>
                        <span class="group-toggle">+</span>
                        ${group}
                        <span class="group-count">(${sets.length}ã‚»ãƒƒãƒˆ)</span>
                    </div>
                `;

                const groupContent = document.createElement('div');
                groupContent.className = 'group-content';
                
                sets.forEach((set, index) => {
                    const setItem = document.createElement('div');
                    setItem.className = 'card-set-item';
                    if (cardSets.indexOf(set) === currentCardSetIndex) {
                        setItem.classList.add('active');
                    }
                    
                    setItem.innerHTML = `
                        <span>${set.name} (${set.cards.length}æš) - ${set.description || ''}</span>
                        <div class="card-set-actions">
                            <button class="secondary" data-action="edit" data-index="${cardSets.indexOf(set)}">ç·¨é›†</button>
                            <button class="delete" data-action="delete" data-index="${cardSets.indexOf(set)}">å‰Šé™¤</button>
                        </div>
                    `;
                    
                    setItem.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            loadCardSet(cardSets.indexOf(set));
                        }
                    });
                    
                    // ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                    setItem.querySelector('[data-action="edit"]').addEventListener('click', (e) => {
                        e.stopPropagation();
                        currentCardSetIndex = cardSets.indexOf(set);
                        showEditCardSetModal();
                    });
                    
                    setItem.querySelector('[data-action="delete"]').addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (confirm(`ã€Œ${set.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
                            deleteCardSet(cardSets.indexOf(set));
                        }
                    });
                    
                    groupContent.appendChild(setItem);
                });

                // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                groupHeader.addEventListener('click', () => {
                    const toggle = groupHeader.querySelector('.group-toggle');
                    const content = groupHeader.nextElementSibling;
                    
                    if (content.classList.contains('expanded')) {
                        content.classList.remove('expanded');
                        toggle.classList.remove('expanded');
                        toggle.textContent = '+';
                    } else {
                        content.classList.add('expanded');
                        toggle.classList.add('expanded');
                        toggle.textContent = 'Ã—';
                    }
                });

                cardSetList.appendChild(groupHeader);
                cardSetList.appendChild(groupContent);
            });
        }

        // ã‚°ãƒ«ãƒ¼ãƒ—ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’æ›´æ–°
        function updateGroupSelectors() {
            const groups = new Set();
            cardSets.forEach(set => {
                if (set.group) {
                    groups.add(set.group);
                }
            });

            // ã‚°ãƒ«ãƒ¼ãƒ—ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®æ›´æ–°
            const groupOptions = cardSetGroup.innerHTML;
            cardSetGroup.innerHTML = groupOptions;
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                cardSetGroup.appendChild(option);
            });

            // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®æ›´æ–°
            const filterOptions = groupFilter.innerHTML;
            groupFilter.innerHTML = filterOptions;
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                groupFilter.appendChild(option);
            });
        }

        // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å¤‰æ›´
        function handleGroupFilterChange() {
            currentGroupFilter = groupFilter.value;
            renderCardSetList();
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ã‚’å±•é–‹
            if (currentGroupFilter) {
                const groupHeaders = document.querySelectorAll('.group-header');
                groupHeaders.forEach(header => {
                    if (header.textContent.includes(currentGroupFilter)) {
                        const toggle = header.querySelector('.group-toggle');
                        const content = header.nextElementSibling;
                        content.classList.add('expanded');
                        toggle.classList.add('expanded');
                        toggle.textContent = 'Ã—';
                    }
                });
            }
        }

        // å˜èªå¸³ã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã‚€
        function loadCardSet(index) {
            if (index < 0 || index >= cardSets.length) return;
            
            currentCardSetIndex = index;
            currentCardIndex = 0;
            isFlipped = false;
            
            const cardSet = cardSets[index];
            currentCardSetName.textContent = cardSet.name;
            cardSetView.style.display = 'block';
            
            renderCardSetList();
            updateCardDisplay();
            renderCardList();
        }

        // ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
        function updateCardDisplay() {
            if (currentCardSetIndex === -1 || cardSets[currentCardSetIndex].cards.length === 0) {
                cardFront.textContent = 'ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“';
                cardBack.style.display = 'none';
                cardFront.style.display = 'block';
                cardDescription.style.display = 'none';
                urlButton.classList.add('disabled');
                urlButton.href = '#';
                mediaContainer.innerHTML = '';
                mediaTypeIndicator.textContent = '';
                totalCardsSpan.textContent = '0';
                currentCardIndexSpan.textContent = '0';
                sideIndicator.textContent = 'è¡¨';
                toggleDescriptionBtn.style.display = 'none';
                return;
            }
            
            const cards = cardSets[currentCardSetIndex].cards;
            const currentCard = cards[currentCardIndex];
            
            cardFront.textContent = currentCard.front;
            cardBack.textContent = currentCard.back;
            
            if (currentCard.description) {
                cardDescription.textContent = currentCard.description;
                cardDescription.style.display = 'none';
                toggleDescriptionBtn.style.display = 'block';
                toggleDescriptionBtn.textContent = 'æ¦‚è¦ã‚’è¡¨ç¤º';
            } else {
                cardDescription.style.display = 'none';
                toggleDescriptionBtn.style.display = 'none';
            }

            if (currentCard.url) {
                urlButton.classList.remove('disabled');
                urlButton.href = currentCard.url;
            } else {
                urlButton.classList.add('disabled');
                urlButton.href = '#';
            }
            
            // ãƒ¡ãƒ‡ã‚£ã‚¢è¡¨ç¤º
            renderMedia(currentCard);
            
            if (isFlipped) {
                cardFront.style.display = 'none';
                cardBack.style.display = 'block';
                sideIndicator.textContent = 'è£';
            } else {
                cardFront.style.display = 'block';
                cardBack.style.display = 'none';
                sideIndicator.textContent = 'è¡¨';
            }
            
            totalCardsSpan.textContent = cards.length;
            currentCardIndexSpan.textContent = currentCardIndex + 1;
        }

        // ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’è¡¨ç¤º
        function renderMedia(card) {
            mediaContainer.innerHTML = '';
            mediaTypeIndicator.textContent = '';
            
            if (card.media) {
                let mediaHtml = '';
                let typeIndicator = '';
                
                if (card.mediaType === 'image') {
                    mediaHtml = `<img src="${card.media}" class="media-preview">`;
                    typeIndicator = 'ç”»åƒ';
                } else if (card.mediaType === 'audio') {
                    mediaHtml = `<audio controls src="${card.media}" class="media-preview"></audio>`;
                    typeIndicator = 'éŸ³å£°';
                } else if (card.mediaType === 'video') {
                    mediaHtml = `<video controls src="${card.media}" class="media-preview"></video>`;
                    typeIndicator = 'å‹•ç”»';
                } else if (card.mediaType === 'text') {
                    mediaHtml = `<div class="additional-text">${card.additionalText || ''}</div>`;
                    typeIndicator = 'ãƒ†ã‚­ã‚¹ãƒˆ';
                }
                
                mediaContainer.innerHTML = mediaHtml;
                mediaTypeIndicator.textContent = typeIndicator;
            }
        }

        // ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        function renderCardList() {
            if (currentCardSetIndex === -1) {
                cardListContainer.innerHTML = '<p>å˜èªå¸³ã‚»ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</p>';
                return;
            }
            
            const cards = cardSets[currentCardSetIndex].cards;
            
            if (cards.length === 0) {
                cardListContainer.innerHTML = '<p>ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            cardListContainer.innerHTML = '';
            
            cards.forEach((card, index) => {
                const cardItem = document.createElement('div');
                cardItem.className = 'card-list-item clearfix';
                if (index === currentCardIndex) {
                    cardItem.classList.add('active');
                }
                
                let mediaHtml = '';
                if (card.media) {
                    if (card.mediaType === 'image') {
                        mediaHtml = `<img src="${card.media}" class="card-list-media">`;
                    } else if (card.mediaType === 'audio') {
                        mediaHtml = `<div class="file-icon">ğŸµ</div>`;
                    } else if (card.mediaType === 'video') {
                        mediaHtml = `<div class="file-icon">ğŸ¬</div>`;
                    } else if (card.mediaType === 'text') {
                        mediaHtml = `<div class="file-icon">ğŸ“</div>`;
                    }
                }
                
                cardItem.innerHTML = `
                    ${mediaHtml}
                    <h4>${card.front}</h4>
                    <p>${card.back}</p>
                    ${card.description ? `<p class="card-description">${card.description}</p>` : ''}
                `;
                
                cardItem.addEventListener('click', () => {
                    currentCardIndex = index;
                    isFlipped = false;
                    updateCardDisplay();
                    if (currentView === 'list') {
                        renderCardList();
                    }
                });
                
                cardListContainer.appendChild(cardItem);
            });
        }

        // ã‚«ãƒ¼ãƒ‰ã‚’åè»¢
        function flipCard() {
            if (currentCardSetIndex === -1 || cardSets[currentCardSetIndex].cards.length === 0) return;
            
            isFlipped = !isFlipped;
            updateCardDisplay();
        }

        // å‰ã®ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
        function showPrevCard() {
            if (currentCardSetIndex === -1) return;
            
            const cards = cardSets[currentCardSetIndex].cards;
            if (cards.length === 0) return;
            
            currentCardIndex = (currentCardIndex - 1 + cards.length) % cards.length;
            isFlipped = false;
            updateCardDisplay();
            if (currentView === 'list') {
                renderCardList();
            }
        }

        // æ¬¡ã®ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
        function showNextCard() {
            if (currentCardSetIndex === -1) return;
            
            const cards = cardSets[currentCardSetIndex].cards;
            if (cards.length === 0) return;
            
            currentCardIndex = (currentCardIndex + 1) % cards.length;
            isFlipped = false;
            updateCardDisplay();
            if (currentView === 'list') {
                renderCardList();
            }
        }

        // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆ
        function switchView(view) {
            currentView = view;
            
            if (view === 'card') {
                cardView.style.display = 'block';
                listView.style.display = 'none';
                viewCardBtn.classList.add('active');
                viewListBtn.classList.remove('active');
            } else {
                cardView.style.display = 'none';
                listView.style.display = 'block';
                viewCardBtn.classList.remove('active');
                viewListBtn.classList.add('active');
                renderCardList();
            }
        }

        // ã‚«ãƒ¼ãƒ‰è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showAddCardModal() {
            if (currentCardSetIndex === -1) {
                alert('ã¾ãšå˜èªå¸³ã‚»ãƒƒãƒˆã‚’é¸æŠã¾ãŸã¯ä½œæˆã—ã¦ãã ã•ã„');
                return;
            }
            
            isEditing = false;
            editCardIndex = -1;
            modalTitle.textContent = 'ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ';
            frontText.value = '';
            backText.value = '';
            cardDescriptionText.value = '';
            cardUrl.value = '';
            mediaUpload.value = '';
            mediaPreviewContainer.innerHTML = '';
            removeMediaBtn.style.display = 'none';
            tempMediaData = null;
            tempMediaType = null;
            tempAdditionalText = null;
            switchTab('media');
            cardModal.style.display = 'flex';
        }

        // ã‚«ãƒ¼ãƒ‰ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showEditCardModal() {
            if (currentCardSetIndex === -1 || cardSets[currentCardSetIndex].cards.length === 0) {
                alert('ç·¨é›†ã™ã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            isEditing = true;
            editCardIndex = currentCardIndex;
            modalTitle.textContent = 'ã‚«ãƒ¼ãƒ‰ã‚’ç·¨é›†';
            
            const card = cardSets[currentCardSetIndex].cards[editCardIndex];
            frontText.value = card.front;
            backText.value = card.back;
            cardDescriptionText.value = card.description || '';
            cardUrl.value = card.url || '';
            additionalText.value = card.additionalText || '';
            
            mediaPreviewContainer.innerHTML = '';
            if (card.media) {
                if (card.mediaType === 'image') {
                    mediaPreviewContainer.innerHTML = `<img src="${card.media}" style="max-width: 100%; max-height: 200px;">`;
                } else if (card.mediaType === 'audio') {
                    mediaPreviewContainer.innerHTML = `<audio controls src="${card.media}" style="width: 100%;"></audio>`;
                } else if (card.mediaType === 'video') {
                    mediaPreviewContainer.innerHTML = `<video controls src="${card.media}" style="max-width: 100%; max-height: 200px;"></video>`;
                } else if (card.mediaType === 'text') {
                    switchTab('text');
                }
                removeMediaBtn.style.display = 'block';
            } else {
                removeMediaBtn.style.display = 'none';
            }
            
            tempMediaData = card.media || null;
            tempMediaType = card.mediaType || null;
            tempAdditionalText = card.additionalText || null;
            
            mediaUpload.value = '';
            
            cardModal.style.display = 'flex';
        }

        // ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’å‡¦ç†
        function handleMediaUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const fileType = file.type.split('/')[0];
            const validTypes = ['image', 'audio', 'video'];
            
            if (!validTypes.includes(fileType)) {
                alert('ç”»åƒã€éŸ³å£°ã€å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (event) => {
                mediaPreviewContainer.innerHTML = '';
                
                if (fileType === 'image') {
                    mediaPreviewContainer.innerHTML = `<img src="${event.target.result}" style="max-width: 100%; max-height: 200px;">`;
                } else if (fileType === 'audio') {
                    mediaPreviewContainer.innerHTML = `<audio controls src="${event.target.result}" style="width: 100%;"></audio>`;
                } else if (fileType === 'video') {
                    mediaPreviewContainer.innerHTML = `<video controls src="${event.target.result}" style="max-width: 100%; max-height: 200px;"></video>`;
                }
                
                removeMediaBtn.style.display = 'block';
                tempMediaData = event.target.result;
                tempMediaType = fileType;
                tempAdditionalText = null;
            };
            reader.readAsDataURL(file);
        }

        // ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’å‰Šé™¤
        function removeMedia() {
            mediaPreviewContainer.innerHTML = '';
            removeMediaBtn.style.display = 'none';
            mediaUpload.value = '';
            tempMediaData = null;
            tempMediaType = null;
            tempAdditionalText = null;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
        function hideModal() {
            cardModal.style.display = 'none';
        }

        // ã‚«ãƒ¼ãƒ‰ã‚’ä¿å­˜
        function saveCard() {
            const front = frontText.value.trim();
            const back = backText.value.trim();
            const description = cardDescriptionText.value.trim();
            const url = cardUrl.value.trim();
            const additional = additionalText.value.trim();
            
            if (!front || !back) {
                alert('è¡¨ã¨è£ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const cardData = {
                front,
                back,
                description: description || undefined,
                url: url || undefined,
                media: tempMediaData || (isEditing ? cardSets[currentCardSetIndex].cards[editCardIndex].media : undefined),
                mediaType: tempMediaType || (isEditing ? cardSets[currentCardSetIndex].cards[editCardIndex].mediaType : undefined),
                additionalText: additional || (tempAdditionalText || (isEditing ? cardSets[currentCardSetIndex].cards[editCardIndex].additionalText : undefined))
            };
            
            if (isEditing) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                cardSets[currentCardSetIndex].cards[editCardIndex] = cardData;
            } else {
                // è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
                cardSets[currentCardSetIndex].cards.push(cardData);
                currentCardIndex = cardSets[currentCardSetIndex].cards.length - 1;
            }
            
            saveToLocalStorage();
            hideModal();
            isFlipped = false;
            updateCardDisplay();
            renderCardList();
            renderCardSetList();
        }

        // ç¾åœ¨ã®ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤
        function deleteCurrentCard() {
            if (currentCardSetIndex === -1 || cardSets[currentCardSetIndex].cards.length === 0) {
                alert('å‰Šé™¤ã™ã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (!confirm('ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            cardSets[currentCardSetIndex].cards.splice(currentCardIndex, 1);
            
            // ã‚«ãƒ¼ãƒ‰ãŒ0æšã«ãªã£ãŸå ´åˆã®å‡¦ç†
            if (cardSets[currentCardSetIndex].cards.length === 0) {
                currentCardIndex = 0;
            } else if (currentCardIndex >= cardSets[currentCardSetIndex].cards.length) {
                currentCardIndex = cardSets[currentCardSetIndex].cards.length - 1;
            }
            
            saveToLocalStorage();
            isFlipped = false;
            updateCardDisplay();
            renderCardList();
            renderCardSetList();
        }

        // å˜èªå¸³ã‚»ãƒƒãƒˆã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportCardSet() {
            if (currentCardSetIndex === -1) return;
            
            const cardSet = cardSets[currentCardSetIndex];
            const dataStr = JSON.stringify(cardSet, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportName = `${cardSet.name}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportName);
            linkElement.click();
        }

        // å˜èªå¸³ã‚»ãƒƒãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function handleImportCardSet(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedSet = JSON.parse(event.target.result);
                    
                    if (!importedSet.name || !Array.isArray(importedSet.cards)) {
                        alert('ç„¡åŠ¹ãªå˜èªå¸³ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™');
                        return;
                    }
                    
                    // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                    const existingIndex = cardSets.findIndex(set => set.name === importedSet.name);
                    if (existingIndex >= 0) {
                        if (!confirm(`ã€Œ${importedSet.name}ã€ã¨ã„ã†åå‰ã®ã‚»ãƒƒãƒˆãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) {
                            return;
                        }
                        cardSets[existingIndex] = importedSet;
                        currentCardSetIndex = existingIndex;
                    } else {
                        cardSets.push(importedSet);
                        currentCardSetIndex = cardSets.length - 1;
                    }
                    
                    saveToLocalStorage();
                    loadCardSet(currentCardSetIndex);
                    renderCardSetList();
                    alert(`ã€Œ${importedSet.name}ã€ã‚’${existingIndex >= 0 ? 'ä¸Šæ›¸ã' : 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆ'}ã—ã¾ã—ãŸ`);
                    
                } catch (error) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            };
            reader.readAsText(file);
            e.target.value = ''; // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠã§ãã‚‹ã‚ˆã†ã«ãƒªã‚»ãƒƒãƒˆ
        }

        // å˜èªå¸³ã‚»ãƒƒãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showEditCardSetModal() {
            if (currentCardSetIndex === -1) return;
            
            const cardSet = cardSets[currentCardSetIndex];
            editCardSetName.value = cardSet.name;
            editCardSetDescription.value = cardSet.description || '';
            cardSetModal.style.display = 'flex';
        }

        // å˜èªå¸³ã‚»ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
        function hideCardSetModal() {
            cardSetModal.style.display = 'none';
        }

        // å˜èªå¸³ã‚»ãƒƒãƒˆã‚’ä¿å­˜
        function saveCardSet() {
            const name = editCardSetName.value.trim();
            if (!name) {
                alert('ã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            cardSets[currentCardSetIndex].name = name;
            cardSets[currentCardSetIndex].description = editCardSetDescription.value.trim() || undefined;
            saveToLocalStorage();
            hideCardSetModal();
            currentCardSetName.textContent = name;
            renderCardSetList();
        }

        // å˜èªå¸³ã‚»ãƒƒãƒˆã‚’å‰Šé™¤
        function deleteCardSet(index) {
            if (index < 0 || index >= cardSets.length) return;
            
            cardSets.splice(index, 1);
            saveToLocalStorage();
            
            if (cardSets.length > 0) {
                loadCardSet(Math.min(index, cardSets.length - 1));
            } else {
                currentCardSetIndex = -1;
                cardSetView.style.display = 'none';
            }
            
            renderCardSetList();
        }

        // ç¾åœ¨ã®å˜èªå¸³ã‚»ãƒƒãƒˆã‚’å‰Šé™¤
        function deleteCurrentCardSet() {
            if (currentCardSetIndex === -1) return;
            deleteCardSet(currentCardSetIndex);
            hideCardSetModal();
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
        function saveToLocalStorage() {
            localStorage.setItem('cardSets', JSON.stringify(cardSets));
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('cardSets');
            if (savedData) {
                cardSets = JSON.parse(savedData);
                renderCardSetList();
            }
        }

        // æ¦‚è¦ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        function toggleDescription(e) {
            e.stopPropagation(); // ã‚«ãƒ¼ãƒ‰ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
            
            const description = document.getElementById('cardDescription');
            const button = document.getElementById('toggleDescription');
            
            if (description.style.display === 'none') {
                description.style.display = 'block';
                button.textContent = 'æ¦‚è¦ã‚’éè¡¨ç¤º';
            } else {
                description.style.display = 'none';
                button.textContent = 'æ¦‚è¦ã‚’è¡¨ç¤º';
            }
        }

        // å…¨ã¦ã®å˜èªå¸³ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportAllCardSets() {
            const dataStr = JSON.stringify(cardSets, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportName = 'all_flashcards.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportName);
            linkElement.click();
        }

        // å…¨ã¦ã®å˜èªå¸³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function handleImportAllCardSets(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedSets = JSON.parse(event.target.result);
                    
                    if (!Array.isArray(importedSets)) {
                        alert('ç„¡åŠ¹ãªå˜èªå¸³ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™');
                        return;
                    }
                    
                    // å„ã‚»ãƒƒãƒˆã®æ¤œè¨¼
                    for (const set of importedSets) {
                        if (!set.name || !Array.isArray(set.cards)) {
                            alert('ç„¡åŠ¹ãªå˜èªå¸³ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™');
                            return;
                        }
                    }
                    
                    if (confirm('ç¾åœ¨ã®å˜èªå¸³ã‚’å…¨ã¦ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                        cardSets = importedSets;
                        saveToLocalStorage();
                        currentCardSetIndex = -1;
                        cardSetView.style.display = 'none';
                        renderCardSetList();
                        alert('å…¨ã¦ã®å˜èªå¸³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
                    }
                    
                } catch (error) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            };
            reader.readAsText(file);
            e.target.value = ''; // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠã§ãã‚‹ã‚ˆã†ã«ãƒªã‚»ãƒƒãƒˆ
        }

        // ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å¤‰æ›´
        function handleGroupChange() {
            const group = cardSetGroup.value;
            if (group === 'new') {
                newGroupName.style.display = 'block';
            } else {
                newGroupName.style.display = 'none';
            }
        }

        // åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
        init();
    </script>
